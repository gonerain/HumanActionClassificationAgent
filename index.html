<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scene Presence Monitor</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    #status {
      margin: 10px 0;
      font-size: 1.2em;
      font-weight: bold;
    }
    #frame {
      border: 2px solid #ccc;
      max-width: 100%;
      height: auto;
    }
    #info {
      margin-top: 10px;
      font-size: 1em;
      color: #555;
    }
    section {
      margin-top: 20px;
    }
    button {
      padding: 6px 12px;
      margin-right: 6px;
    }
    pre {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      overflow-x: auto;
    }
    #alarm {
      margin: 8px 0;
      padding: 8px;
      color: #fff;
      background: #d32f2f;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Scene Presence Monitor (Multi-Camera)</h1>

  <section id="cameraSection">
    <h2>Cameras</h2>
    <div>
      <button id="refreshCamerasBtn">Refresh</button>
      <label>
        Select:
        <select id="cameraSelect"></select>
      </label>
      <button id="deleteCameraBtn">Delete</button>
    </div>
    <pre id="camerasList"></pre>
  </section>

  <section id="liveSection">
    <h2>Live</h2>
    <div id="status">No camera selected</div>
    <div id="alarm"></div>
    <img id="frame" src="" alt="Live Feed">
    <div id="info"></div>
  </section>

  <section id="snapshotSection">
    <h2>Snapshot</h2>
    <button id="snapshotBtn">Fetch Snapshot</button>
    <img id="snapshot" src="" alt="Snapshot" style="display:none; border:2px solid #ccc; max-width:100%; height:auto;">
    <pre id="snapshotInfo"></pre>
  </section>

  <section id="reportSection">
    <h2>Inference Report</h2>
    <button id="reportBtn">Fetch Report</button>
    <pre id="reportInfo"></pre>
  </section>

  <section id="dwellSection">
    <h2>Dwell Events</h2>
    <button id="dwellBtn">Fetch Dwell Events</button>
    <pre id="dwellInfo"></pre>
  </section>

  <section id="manageSection">
    <h2>Create / Update Camera</h2>
    <div>
      <input type="text" id="camNameInput" placeholder="Name (e.g. camA)">
      <input type="text" id="sourceInput" placeholder="Source (e.g. 0 or rtsp://..)">
      <input type="text" id="regionInput" placeholder='Region JSON e.g. [[0,0],[100,0]]'>
    </div>
    <div style="margin-top:8px;">
      <button id="createCameraBtn">Create</button>
      <button id="updateCameraBtn">Update Selected</button>
    </div>
    <pre id="manageStatus"></pre>
  </section>

  <script>
    const statusDiv = document.getElementById("status");
    const frameImg = document.getElementById("frame");
    const infoDiv = document.getElementById("info");
    const alarmDiv = document.getElementById("alarm");
    const cameraSelect = document.getElementById("cameraSelect");
    const camerasList = document.getElementById("camerasList");
    const refreshCamerasBtn = document.getElementById("refreshCamerasBtn");
    const deleteCameraBtn = document.getElementById("deleteCameraBtn");
    const snapshotBtn = document.getElementById("snapshotBtn");
    const snapshotImg = document.getElementById("snapshot");
    const snapshotInfo = document.getElementById("snapshotInfo");
    const reportBtn = document.getElementById("reportBtn");
    const reportInfo = document.getElementById("reportInfo");
    const dwellBtn = document.getElementById("dwellBtn");
    const dwellInfo = document.getElementById("dwellInfo");
    const camNameInput = document.getElementById("camNameInput");
    const sourceInput = document.getElementById("sourceInput");
    const regionInput = document.getElementById("regionInput");
    const createCameraBtn = document.getElementById("createCameraBtn");
    const updateCameraBtn = document.getElementById("updateCameraBtn");
    const manageStatus = document.getElementById("manageStatus");

    let socket = null;
    const wsProto = location.protocol === "https:" ? "wss" : "ws";

    function closeSocket() {
      if (socket) {
        try { socket.close(); } catch(e) {}
      }
      socket = null;
    }

    function connectWS(cameraId) {
      closeSocket();
      statusDiv.textContent = "Connecting...";
      socket = new WebSocket(`${wsProto}://${location.host}/cameras/${cameraId}/status`);
      socket.onopen = () => {
        statusDiv.textContent = `âœ… Connected to camera ${cameraId}`;
      };
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.frame) {
          frameImg.src = "data:image/jpeg;base64," + data.frame;
        }
        statusDiv.textContent = data.scene_active
          ? `ðŸŸ¢ Camera ${cameraId}: æœ‰äººåœ¨å²—`
          : `ðŸ”´ Camera ${cameraId}: æ— äººåœ¨å²—`;
        infoDiv.innerHTML = `
          <strong>Active IDs:</strong> ${data.active_ids.join(", ")}<br>
          <strong>Roll Status:</strong> ${data.roll_status}<br>
          <strong>Health:</strong> ${data.health ? data.health.status : 'n/a'}
        `;
        if (data.alarm) {
          alarmDiv.style.display = 'block';
          alarmDiv.textContent = `âš ï¸ å¼‚å¸¸ï¼š${data.alarm_message || 'unknown'}`;
        } else {
          alarmDiv.style.display = 'none';
          alarmDiv.textContent = '';
        }
      };
      socket.onerror = () => { statusDiv.textContent = `âŒ Camera ${cameraId} WebSocket error`; };
      socket.onclose = () => { statusDiv.textContent = `ðŸ”Œ Camera ${cameraId} WebSocket closed`; };
    }

    async function loadCameras() {
      const resp = await fetch('/cameras');
      const cams = await resp.json();
      camerasList.textContent = JSON.stringify(cams, null, 2);
      cameraSelect.innerHTML = '';
      for (const cam of cams) {
        const opt = document.createElement('option');
        opt.value = cam.id;
        opt.textContent = `#${cam.id} ${cam.name} (${cam.running ? 'running' : 'stopped'})`;
        cameraSelect.appendChild(opt);
      }
      if (cams.length > 0) {
        cameraSelect.value = cams[0].id;
        connectWS(cams[0].id);
      } else {
        statusDiv.textContent = 'No camera selected';
        closeSocket();
        frameImg.src = '';
        infoDiv.textContent = '';
      }
    }

    refreshCamerasBtn.onclick = loadCameras;
    cameraSelect.onchange = () => {
      const id = cameraSelect.value;
      if (id) connectWS(id);
    };

    deleteCameraBtn.onclick = async () => {
      const id = cameraSelect.value;
      if (!id) return;
      await fetch(`/cameras/${id}`, { method: 'DELETE' });
      await loadCameras();
    };

    snapshotBtn.onclick = async () => {
      const id = cameraSelect.value;
      if (!id) return;
      const resp = await fetch(`/cameras/${id}/snapshot`);
      const data = await resp.json();
      if (data.frame) {
        snapshotImg.src = "data:image/jpeg;base64," + data.frame;
        snapshotImg.style.display = "block";
      }
      snapshotInfo.textContent = JSON.stringify(data, null, 2);
    };

    reportBtn.onclick = async () => {
      const id = cameraSelect.value;
      if (!id) return;
      const resp = await fetch(`/cameras/${id}/inference/report`);
      const data = await resp.json();
      reportInfo.textContent = JSON.stringify(data, null, 2);
    };

    dwellBtn.onclick = async () => {
      const id = cameraSelect.value;
      if (!id) return;
      const resp = await fetch(`/cameras/${id}/dwell_events`);
      const data = await resp.json();
      dwellInfo.textContent = JSON.stringify(data, null, 2);
    };

    createCameraBtn.onclick = async () => {
      const name = camNameInput.value.trim() || undefined;
      const source = sourceInput.value.trim() || undefined;
      let region = undefined;
      const regionVal = regionInput.value.trim();
      if (regionVal) {
        try { region = JSON.parse(regionVal); } catch (e) { manageStatus.textContent = 'Invalid region JSON'; return; }
      }
      const resp = await fetch('/cameras', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, source, region })
      });
      const data = await resp.json();
      manageStatus.textContent = JSON.stringify(data, null, 2);
      await loadCameras();
    };

    updateCameraBtn.onclick = async () => {
      const id = cameraSelect.value;
      if (!id) return;
      const payload = {};
      if (camNameInput.value.trim()) payload.name = camNameInput.value.trim();
      if (sourceInput.value.trim()) payload.source = sourceInput.value.trim();
      if (regionInput.value.trim()) {
        try { payload.region = JSON.parse(regionInput.value.trim()); } catch (e) { manageStatus.textContent = 'Invalid region JSON'; return; }
      }
      const resp = await fetch(`/cameras/${id}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      manageStatus.textContent = JSON.stringify(data, null, 2);
      await loadCameras();
    };

    // initial load
    loadCameras();
  </script>
</body>
</html>
